---
title: "Expanded metadata for the core NTL-LTER datasets"
author: "Hilary Dugan"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    # css: styles.css
  pdf_document: default
---

<style>
code {
  white-space: nowrap;
}
</style>


<!-- Get Libraries -->
```{r libraries, echo=FALSE, message = FALSE, warning = FALSE}
library(xml2)
library(rvest)
library(stringr)
library(tidyverse)
library(formatR)
library(EDIutils)
```

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 500), tidy = TRUE)
```

---

<!-- Get Links -->
```{r pressure, echo=FALSE}
URL <- "https://lter.limnology.wisc.edu/core-datasets/"
pg <- read_html(URL)
links = as_tibble(html_attr(html_nodes(pg, "a"), "href")) %>%
  filter(str_detect(value, 'knb-lter-ntl'))

```

```{r testlink, results='asis', echo = FALSE, message = FALSE, warning = FALSE}
##### Get info from core datasets
options(width = 500)

for (i in 2:nrow(links)) {
  
  # Get dataset URL
  coreLink = links$value[i]
  getidentifier <- stringr::str_extract(coreLink, "(?<=identifier=)\\d+")
   
  revision = list_data_package_revisions(scope = 'knb-lter-ntl', identifier = getidentifier, filter = "newest")
  packageid = paste0('knb-lter-ntl.',getidentifier,'.', revision)
  res = read_data_entity_names(packageid)
  raw = read_data_entity(packageId = packageid, entityId = res$entityId[1])
  dt1 = read_csv(file = raw)
  
  # # Get metadatalink
  # meta = head(html_attr(html_nodes(pg2, "a")[[32]], "href"))
  # metadatalink = paste0("https://portal.edirepository.org/nis/", meta)
  # pg3 <- read_html(metadatalink)
  # html_text2(html_elements(pg3, "li"))

  # Get package ID to get EML metadata

  meta.xml = read_metadata(packageId = packageid)
  eml_keywords <- xml_text(xml_find_all(meta.xml, './/keyword'))
  
  # Keep core areas 
  keepKeywords = eml_keywords[eml_keywords %in% c('Primary Production', 'primary production',
                                                  'Populations', 'populations',
                                                  'inorganic nutrients', 'Inorganic Matter', 
                                                  'Organic Matter', 'organic matter',
                                                  'Disturbance', 'disturbance')]
  
  ### Get title 
    cat('## ',res$entityName, '\n\n')

   # Print Keywords
  cat('**Core Areas**: ',paste(keepKeywords, collapse=", "), '\n\n')
  
  # All Keywords
  cat('**Keywords**: ', paste(eml_keywords, collapse=", "), '\n\n')
  
  # Print URL
  cat('**EDI Archive + Metadata**: ',coreLink, '\n\n')
  
  # variables in dataset
  varnames = names(dt1)
  cat('**Variables include**: ',paste0(varnames, collapse=", "), '\n\n')
  
  # Dates
  if("sampledate" %in% varnames) {
    firstdate = min(dt1$sampledate, na.rm = T)
    enddate = max(dt1$sampledate, na.rm = T)
    
    cat('**Date Range**: ',as.character(firstdate), ' - ', as.character(enddate), '\n\n')
  }
  if("sample_date" %in% varnames) {
    firstdate = min(dt1$sample_date, na.rm = T)
    enddate = max(dt1$sample_date, na.rm = T)
    
    cat('**Date Range**: ',as.character(firstdate), ' - ', as.character(enddate), '\n\n')
  }
  
    # Number of entries
  cat('**No. of entries**: ',paste0(nrow(dt1), collapse=", "), '\n\n')
  
  # cycle through lakes 
  if("lakeid" %in% varnames) {
    lakenames = unique(dt1$lakeid)
    
    if("depth" %in% varnames) {
      cat('**Lakes included**: ', '\n\n')
      for (n in lakenames) {
        # print lake name
        cat('**', n,'**', ', ', sep = '')
        
        uselake = dt1 |> filter(lakeid == n)
        usedepths = uselake |> group_by(depth) |> tally() |> filter(n > 50) |> pull(depth)
        
        # Print depths for that lake
        cat('depths include: ',paste0(usedepths, collapse=", "), '\n\n')
      } 
    } else {
      # print lake name
      cat('**Lakes included**: ',paste0(lakenames, collapse=", "), '\n\n')
    }
  }
}


```

## Session Info
```{r session}
R.version
```
